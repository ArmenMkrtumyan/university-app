# Azure DevOps Pipeline Configuration
# This pipeline automatically triggers when changes are pushed to the main branch
# It builds Docker images and deploys to Azure using FREE tier services

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - README.md
      - mkdocs/*
      - '*.md'

pool:
  vmImage: 'ubuntu-latest'

variables:
  # Azure Container Registry (Free tier: 500MB storage, 10K pulls/day)
  ACR_NAME: 'universityApp'  # Your Azure Container Registry name
  dockerRegistryServiceConnection: 'ACR-Connection'
  containerRegistry: '$(ACR_NAME).azurecr.io'
  imageRepository: 'university-app'
  
  # Azure App Service names (Free tier F1)
  # These match your actual App Service names in Azure
  apiAppName: 'api-armen-2025'
  frontendAppName: 'api-frontend-armen'
  
  # Image tags
  dockerfilePath: '$(Build.SourcesDirectory)/university_app'
  tag: '$(Build.BuildId)'
  
  # Database connection - Update this with your actual PostgreSQL connection string
  # Format: postgresql://username:password@host:port/database
  # You can get this from Azure Portal -> Container Instances -> university-postgres -> Connect
  DATABASE_URL: 'postgresql://postgres:very_secure_password@university-postgres.afabckgdgwfqh4dj.belgiumcentral.azurecontainer.io:5432/university_db'

stages:
  - stage: Build
    displayName: 'Build Docker Images'
    jobs:
      - job: BuildImages
        displayName: 'Build and Push Images'
        steps:
          - checkout: self
            displayName: 'Checkout code from Azure DevOps'
            fetchDepth: 1

          - script: |
              echo "Repository: $(Build.Repository.Name)"
              echo "Branch: $(Build.SourceBranch)"
              echo "Commit: $(Build.SourceVersion)"
              echo "Building images for Azure deployment..."
            displayName: 'Display build information'

          # Build and push API image
          - task: Docker@2
            displayName: 'Build and Push API Image'
            inputs:
              command: buildAndPush
              repository: $(imageRepository)-api
              dockerfile: '$(dockerfilePath)/api/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              buildContext: '$(dockerfilePath)'
              tags: |
                $(tag)
                latest

          # Build Frontend image (separate build step to support build args)
          - task: Docker@2
            displayName: 'Build Frontend Image'
            inputs:
              command: build
              repository: $(imageRepository)-app
              dockerfile: '$(dockerfilePath)/app/Dockerfile'
              containerRegistry: $(dockerRegistryServiceConnection)
              buildContext: '$(dockerfilePath)/app'
              tags: |
                $(tag)
                latest
              arguments: '--build-arg VITE_API_URL=https://$(apiAppName).azurewebsites.net'
          
          # Push Frontend image
          - task: Docker@2
            displayName: 'Push Frontend Image'
            inputs:
              command: push
              repository: $(imageRepository)-app
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
                latest

  - stage: Deploy
    displayName: 'Deploy to Azure (Free Tier)'
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployToAzure
        displayName: 'Deploy Application to Azure'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                # Configure Container Registry authentication and deploy API
                - task: AzureCLI@2
                  displayName: 'Configure API Container Registry Auth and Deploy'
                  inputs:
                    azureSubscription: 'Azure-Subscription'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Enable Admin user on Container Registry
                      az acr update --name $(ACR_NAME) --admin-enabled true --output none
                      
                      # Get Container Registry credentials
                      ACR_USERNAME=$(az acr credential show --name $(ACR_NAME) --query "username" -o tsv)
                      ACR_PASSWORD=$(az acr credential show --name $(ACR_NAME) --query "passwords[0].value" -o tsv)
                      ACR_LOGIN_SERVER=$(az acr show --name $(ACR_NAME) --query "loginServer" -o tsv)
                      
                      # Configure API App Service with Container Registry authentication
                      az webapp config container set \
                        --resource-group university-app-rg \
                        --name $(apiAppName) \
                        --docker-custom-image-name "${ACR_LOGIN_SERVER}/$(imageRepository)-api:latest" \
                        --docker-registry-server-url "https://${ACR_LOGIN_SERVER}" \
                        --docker-registry-server-user "$ACR_USERNAME" \
                        --docker-registry-server-password "$ACR_PASSWORD" \
                        --output none
                      
                      # Set application settings
                      az webapp config appsettings set \
                        --resource-group university-app-rg \
                        --name $(apiAppName) \
                        --settings \
                          DATABASE_URL="$(DATABASE_URL)" \
                          PYTHONUNBUFFERED=1 \
                          PYTHONDONTWRITEBYTECODE=1 \
                          WEBSITES_PORT=8000 \
                          WEBSITES_ENABLE_APP_SERVICE_STORAGE=false \
                        --output none
                      
                      # Restart to pull new image
                      az webapp restart --resource-group university-app-rg --name $(apiAppName) --output none
                
                # Configure Container Registry authentication and deploy Frontend
                - task: AzureCLI@2
                  displayName: 'Configure Frontend Container Registry Auth and Deploy'
                  inputs:
                    azureSubscription: 'Azure-Subscription'
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      # Get Container Registry credentials (already enabled above)
                      ACR_USERNAME=$(az acr credential show --name $(ACR_NAME) --query "username" -o tsv)
                      ACR_PASSWORD=$(az acr credential show --name $(ACR_NAME) --query "passwords[0].value" -o tsv)
                      ACR_LOGIN_SERVER=$(az acr show --name $(ACR_NAME) --query "loginServer" -o tsv)
                      
                      # Configure Frontend App Service with Container Registry authentication
                      az webapp config container set \
                        --resource-group university-app-rg \
                        --name $(frontendAppName) \
                        --docker-custom-image-name "${ACR_LOGIN_SERVER}/$(imageRepository)-app:latest" \
                        --docker-registry-server-url "https://${ACR_LOGIN_SERVER}" \
                        --docker-registry-server-user "$ACR_USERNAME" \
                        --docker-registry-server-password "$ACR_PASSWORD" \
                        --output none
                      
                      # Set application settings
                      az webapp config appsettings set \
                        --resource-group university-app-rg \
                        --name $(frontendAppName) \
                        --settings \
                          WEBSITES_PORT=80 \
                        --output none
                      
                      # Restart to pull new image
                      az webapp restart --resource-group university-app-rg --name $(frontendAppName) --output none

                - script: |
                    echo "## Deployment Complete!"
                    echo "Frontend URL: https://$(frontendAppName).azurewebsites.net"
                    echo "API URL: https://$(apiAppName).azurewebsites.net"
                    echo "API Docs: https://$(apiAppName).azurewebsites.net/docs"
                  displayName: 'Display Deployment URLs'


